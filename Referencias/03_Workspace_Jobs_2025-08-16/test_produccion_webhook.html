<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Webhook Producci√≥n - juanda.pro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #0c5460;
            background: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Webhook Producci√≥n</h1>
        <p><strong>Sitio:</strong> https://juanda.pro</p>
        
        <div class="info">
            <strong>‚ö†Ô∏è Importante:</strong> Este test debe ejecutarse desde el sitio en producci√≥n (https://juanda.pro) para tener acceso a las variables de entorno de Vercel.
        </div>

        <div style="margin: 20px 0;">
            <button class="button" onclick="testVariablesEntorno()">1. Verificar Variables de Entorno</button>
            <button class="button" onclick="testWebhookConnectivity()">2. Test Conectividad Webhook</button>
            <button class="button" onclick="testWebhookCompleto()">3. Test Webhook Completo</button>
            <button class="button" onclick="testFormularioReal()">4. Test Formulario Real</button>
            <button class="button" onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
        </div>

        <div id="results"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showResult(message, type = 'info') {
            const resultsElement = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            resultsElement.appendChild(div);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }

        async function testVariablesEntorno() {
            log('üîç Verificando variables de entorno...');
            
            try {
                // Simular acceso a variables de entorno como lo har√≠a la aplicaci√≥n
                const variables = {
                    VITE_WEBHOOK_URL: import.meta.env?.VITE_WEBHOOK_URL || 'NO DEFINIDA',
                    VITE_WEBHOOK_TOKEN: import.meta.env?.VITE_WEBHOOK_TOKEN || 'NO DEFINIDA',
                    VITE_SUPABASE_URL: import.meta.env?.VITE_SUPABASE_URL || 'NO DEFINIDA',
                    VITE_SUPABASE_ANON_KEY: import.meta.env?.VITE_SUPABASE_ANON_KEY || 'NO DEFINIDA'
                };

                log('Variables encontradas:');
                Object.entries(variables).forEach(([key, value]) => {
                    const status = value !== 'NO DEFINIDA' ? '‚úÖ' : '‚ùå';
                    const displayValue = key.includes('TOKEN') || key.includes('KEY') ? 
                        (value !== 'NO DEFINIDA' ? '[DEFINIDA]' : '[NO DEFINIDA]') : value;
                    log(`  ${status} ${key}: ${displayValue}`);
                });

                const missingVars = Object.entries(variables)
                    .filter(([key, value]) => value === 'NO DEFINIDA')
                    .map(([key]) => key);

                if (missingVars.length > 0) {
                    showResult(`‚ùå Variables faltantes: ${missingVars.join(', ')}`, 'error');
                    log('‚ùå PROBLEMA IDENTIFICADO: Variables de entorno faltantes en Vercel', 'error');
                } else {
                    showResult('‚úÖ Todas las variables de entorno est√°n configuradas', 'success');
                    log('‚úÖ Variables de entorno OK', 'success');
                }

            } catch (error) {
                log(`‚ùå Error verificando variables: ${error.message}`, 'error');
                showResult('‚ùå Error accediendo a variables de entorno', 'error');
            }
        }

        async function testWebhookConnectivity() {
            log('üåê Probando conectividad del webhook...');
            
            try {
                const webhookUrl = import.meta.env?.VITE_WEBHOOK_URL;
                
                if (!webhookUrl) {
                    log('‚ùå VITE_WEBHOOK_URL no est√° definida', 'error');
                    showResult('‚ùå No se puede probar: VITE_WEBHOOK_URL faltante', 'error');
                    return;
                }

                log(`üîó URL del webhook: ${webhookUrl}`);
                
                // Test b√°sico de conectividad
                const response = await fetch(webhookUrl, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                
                log('‚úÖ Conectividad b√°sica OK', 'success');
                showResult('‚úÖ El webhook es accesible', 'success');
                
            } catch (error) {
                log(`‚ùå Error de conectividad: ${error.message}`, 'error');
                showResult('‚ùå Problema de conectividad con el webhook', 'error');
            }
        }

        async function testWebhookCompleto() {
            log('üöÄ Ejecutando test completo del webhook...');
            
            try {
                const webhookUrl = import.meta.env?.VITE_WEBHOOK_URL;
                const webhookToken = import.meta.env?.VITE_WEBHOOK_TOKEN;
                
                if (!webhookUrl || !webhookToken) {
                    log('‚ùå Variables del webhook faltantes', 'error');
                    showResult('‚ùå No se puede probar: Variables del webhook faltantes', 'error');
                    return;
                }

                // Datos de prueba
                const testData = {
                    timestamp: Date.now(),
                    name: 'Test Producci√≥n',
                    email: 'test@produccion.com',
                    message: 'Mensaje de prueba desde producci√≥n'
                };

                log('üì§ Enviando datos de prueba...');
                log(`Datos: ${JSON.stringify(testData, null, 2)}`);

                // Construir URL con par√°metros
                const url = new URL(webhookUrl);
                Object.entries(testData).forEach(([key, value]) => {
                    url.searchParams.append(key, value.toString());
                });

                log(`üîó URL final: ${url.toString()}`);

                // Realizar petici√≥n
                const startTime = Date.now();
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'contact_form': webhookToken,
                        'Content-Type': 'application/json'
                    }
                });
                const endTime = Date.now();

                log(`‚è±Ô∏è Tiempo de respuesta: ${endTime - startTime}ms`);
                log(`üìä Status: ${response.status} ${response.statusText}`);

                if (response.ok) {
                    log('‚úÖ Webhook respondi√≥ correctamente', 'success');
                    showResult('‚úÖ Test del webhook exitoso', 'success');
                } else {
                    log(`‚ùå Webhook fall√≥: ${response.status} ${response.statusText}`, 'error');
                    showResult(`‚ùå Webhook fall√≥: ${response.status}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error en test del webhook: ${error.message}`, 'error');
                showResult('‚ùå Error ejecutando test del webhook', 'error');
            }
        }

        async function testFormularioReal() {
            log('üìù Probando formulario real de la p√°gina...');
            
            try {
                // Buscar el formulario en la p√°gina
                const form = document.querySelector('form[data-contact-form]') || 
                           document.querySelector('form');
                
                if (!form) {
                    log('‚ùå No se encontr√≥ formulario en la p√°gina', 'error');
                    showResult('‚ùå Formulario no encontrado', 'error');
                    return;
                }

                log('‚úÖ Formulario encontrado en la p√°gina');
                
                // Verificar campos del formulario
                const nameField = form.querySelector('input[name="name"], input[id*="name"]');
                const emailField = form.querySelector('input[name="email"], input[id*="email"]');
                const messageField = form.querySelector('textarea[name="message"], textarea[id*="message"]');
                
                log(`üìã Campos encontrados:`);
                log(`  - Nombre: ${nameField ? '‚úÖ' : '‚ùå'}`);
                log(`  - Email: ${emailField ? '‚úÖ' : '‚ùå'}`);
                log(`  - Mensaje: ${messageField ? '‚úÖ' : '‚ùå'}`);
                
                if (nameField && emailField && messageField) {
                    showResult('‚úÖ Estructura del formulario correcta', 'success');
                    log('üí° Sugerencia: Prueba enviar el formulario manualmente para verificar funcionamiento', 'info');
                } else {
                    showResult('‚ùå Estructura del formulario incompleta', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error analizando formulario: ${error.message}`, 'error');
                showResult('‚ùå Error analizando formulario', 'error');
            }
        }

        // Ejecutar verificaci√≥n inicial al cargar
        window.addEventListener('load', () => {
            log('üöÄ Herramienta de diagn√≥stico cargada');
            log('üìç Ejecut√°ndose desde: ' + window.location.href);
            
            if (!window.location.href.includes('juanda.pro')) {
                showResult('‚ö†Ô∏è ADVERTENCIA: Esta herramienta debe ejecutarse desde https://juanda.pro para acceder a las variables de entorno de Vercel', 'error');
            }
        });
    </script>
</body>
</html>